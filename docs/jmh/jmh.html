<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JMH Benchmark Results Visualizer</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --error-color: #e74c3c;
        --warning-color: #f39c12;
        --background-color: #f9f9f9;
        --card-color: #ffffff;
        --text-color: #333333;
        --border-color: #dddddd;
    }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 20px;
    }

    h1 {
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .subtitle {
        color: #666;
        font-size: 1.1em;
    }

    .controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
        background-color: var(--card-color);
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .control-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    button, select {
        padding: 8px 15px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        font-size: 14px;
    }

    button:hover, select:hover {
        background-color: #2980b9;
    }

    button:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
    }

    .drag-drop-area {
        border: 2px dashed var(--border-color);
        border-radius: 5px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        background-color: var(--card-color);
        transition: all 0.3s;
        display: none;
    }

    .drag-drop-area.active {
        border-color: var(--primary-color);
        background-color: #f0f8ff;
    }

    .drag-drop-area p {
        margin: 0;
        font-size: 16px;
    }

    .drag-drop-area .hint {
        font-size: 14px;
        color: #777;
        margin-top: 10px;
    }

    .benchmark-group {
        background-color: var(--card-color);
        border-radius: 5px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .group-header {
        padding: 15px;
        background-color: var(--primary-color);
        color: white;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s;
    }

    .group-header:hover {
        background-color: #2980b9;
    }

    .group-header h2 {
        margin: 0;
        font-size: 1.2em;
    }

    .group-content {
        padding: 0;
        display: none;
    }

    .group-content.expanded {
        display: block;
    }

    .environment-info {
        background-color: #f5f5f5;
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9em;
    }

    .chart-container {
        margin: 20px;
        position: relative;
        height: 500px;
    }

    .chart-actions {
        display: flex;
        gap: 10px;
        margin: 0 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
    }

    .error-message {
        color: var(--error-color);
        padding: 15px;
        background-color: #ffeaea;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
        border-left: 4px solid var(--error-color);
    }

    .warning-message {
        color: var(--warning-color);
        padding: 15px;
        background-color: #fff8e6;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
        border-left: 4px solid var(--warning-color);
    }

    footer {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        color: #777;
    }

    .copy-success {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--secondary-color);
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: none;
        z-index: 1000;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary-color);
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #777;
    }

    @media (max-width: 768px) {
        .controls {
            flex-direction: column;
        }

        .control-group {
            width: 100%;
            justify-content: space-between;
        }

        .chart-container {
            height: 400px;
        }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>JMH Benchmark Results Visualizer</h1>
    <p class="subtitle">Visualize and analyze JMH benchmark results with interactive charts</p>
  </header>

  <div class="controls">
    <div class="control-group">
      <button id="loadDefaultBtn">Load Default results.json</button>
      <button id="toggleDragDropBtn">Toggle Drag & Drop</button>
      <button id="sortAllBtn">Sort All Benchmarks</button>
    </div>
    <div class="control-group">
      <select id="chartTypeSelect">
        <option value="vertical">Vertical Bar Chart</option>
        <option value="horizontal">Horizontal Bar Chart</option>
      </select>
      <select id="rendererSelect">
        <option value="canvas">Canvas</option>
        <option value="svg">SVG</option>
      </select>
    </div>
  </div>

  <div id="dragDropArea" class="drag-drop-area">
    <p>Drag and drop your results.json file here</p>
    <p class="hint">or click anywhere in this area to select a file</p>
  </div>

  <div id="errorMessage" class="error-message"></div>
  <div id="warningMessage" class="warning-message"></div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading and processing benchmark data...</p>
  </div>

  <div id="resultsContainer">
    <div class="no-data">
      <h3>No benchmark data loaded</h3>
      <p>Load a JMH results.json file using the buttons above or by dragging and dropping a file.</p>
    </div>
  </div>

  <footer>
    <p>Created by Alex Johnson</p>
  </footer>

  <div id="copySuccess" class="copy-success">SVG code copied to clipboard!</div>
</div>

<script>
  // Global variables
  let benchmarkData = null;
  let chartInstances = [];

  // DOM elements
  const loadDefaultBtn = document.getElementById('loadDefaultBtn');
  const toggleDragDropBtn = document.getElementById('toggleDragDropBtn');
  const sortAllBtn = document.getElementById('sortAllBtn');
  const chartTypeSelect = document.getElementById('chartTypeSelect');
  const rendererSelect = document.getElementById('rendererSelect');
  const dragDropArea = document.getElementById('dragDropArea');
  const errorMessage = document.getElementById('errorMessage');
  const warningMessage = document.getElementById('warningMessage');
  const resultsContainer = document.getElementById('resultsContainer');
  const copySuccess = document.getElementById('copySuccess');
  const loading = document.getElementById('loading');

  // Event listeners
  loadDefaultBtn.addEventListener('click', loadDefaultFile);
  toggleDragDropBtn.addEventListener('click', toggleDragDrop);
  sortAllBtn.addEventListener('click', sortAllBenchmarks);
  chartTypeSelect.addEventListener('change', renderAllCharts);
  rendererSelect.addEventListener('change', renderAllCharts);

  // Make drag-drop area clickable
  dragDropArea.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
          if (e.target.files.length) {
              readFile(e.target.files[0]);
          }
      };
      input.click();
  });

  // Drag and drop event listeners
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dragDropArea.addEventListener(eventName, preventDefaults, false);
  });

  ['dragenter', 'dragover'].forEach(eventName => {
      dragDropArea.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
      dragDropArea.addEventListener(eventName, unhighlight, false);
  });

  dragDropArea.addEventListener('drop', handleDrop, false);

  // Check if ECharts is available
  if (typeof echarts === 'undefined') {
      showError('ECharts library is not loaded. Please check your internet connection.');
      disableControls();
  }

  // Functions
  function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
  }

  function highlight() {
      dragDropArea.classList.add('active');
  }

  function unhighlight() {
      dragDropArea.classList.remove('active');
  }

  function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;

      if (files.length) {
          const file = files[0];
          if (file.type === 'application/json' || file.name.endsWith('.json')) {
              readFile(file);
          } else {
              showError('Please upload a JSON file');
          }
      }
  }

  function disableControls() {
      loadDefaultBtn.disabled = true;
      toggleDragDropBtn.disabled = true;
      sortAllBtn.disabled = true;
      chartTypeSelect.disabled = true;
      rendererSelect.disabled = true;
  }

  function enableControls() {
      loadDefaultBtn.disabled = false;
      toggleDragDropBtn.disabled = false;
      sortAllBtn.disabled = false;
      chartTypeSelect.disabled = false;
      rendererSelect.disabled = false;
  }

  function toggleDragDrop() {
      dragDropArea.style.display = dragDropArea.style.display === 'none' ? 'block' : 'none';
  }

  function showLoading() {
      loading.style.display = 'block';
      resultsContainer.innerHTML = '';
  }

  function hideLoading() {
      loading.style.display = 'none';
  }

  function loadDefaultFile() {
      showLoading();
      fetch('./results.json')
          .then(response => {
              if (!response.ok) {
                  throw new Error('results.json not found in current directory');
              }
              return response.json();
          })
          .then(data => {
              hideError();
              processData(data);
          })
          .catch(error => {
              hideLoading();
              showError(error.message);
          });
  }

  function readFile(file) {
      showLoading();
      const reader = new FileReader();
      reader.onload = function(e) {
          try {
              const data = JSON.parse(e.target.result);
              hideError();
              processData(data);
          } catch (error) {
              hideLoading();
              showError('Invalid JSON file: ' + error.message);
          }
      };
      reader.onerror = function() {
          hideLoading();
          showError('Error reading file');
      };
      reader.readAsText(file);
  }

  function processData(data) {
      // Validate JMH results structure
      if (!validateJMHData(data)) {
          hideLoading();
          showError('Invalid JMH results format. Please provide a valid JMH results.json file.');
          return;
      }

      benchmarkData = data;

      // Group benchmarks by class
      const groupedData = groupBenchmarksByClass(data);

      renderResults(groupedData);
      hideLoading();

      // Show warning if no primary metrics found
      if (Object.keys(groupedData).length === 0) {
          showWarning('No benchmark results with primary metrics found in the data.');
      }
  }

  function validateJMHData(data) {
      if (!Array.isArray(data)) {
          return false;
      }

      // Check if at least one item has JMH benchmark structure
      return data.some(item =>
          item &&
          typeof item === 'object' &&
          item.benchmark &&
          item.primaryMetric
      );
  }

  function groupBenchmarksByClass(data) {
      const groupedData = {};

      data.forEach(benchmark => {
          // Skip if no primary metric score
          if (!benchmark.primaryMetric || typeof benchmark.primaryMetric.score !== 'number') {
              return;
          }

          const benchmarkPath = benchmark.benchmark.split('.');
          const className = benchmarkPath[benchmarkPath.length - 2];

          if (!groupedData[className]) {
              groupedData[className] = [];
          }

          groupedData[className].push(benchmark);
      });

      return groupedData;
  }

  function renderResults(groupedData) {
      resultsContainer.innerHTML = '';
      chartInstances = [];

      if (Object.keys(groupedData).length === 0) {
          resultsContainer.innerHTML = `
              <div class="no-data">
                  <h3>No benchmark data available</h3>
                  <p>The loaded file does not contain any valid benchmark results with scores.</p>
              </div>
          `;
          return;
      }

      Object.keys(groupedData).forEach(className => {
          const group = document.createElement('div');
          group.className = 'benchmark-group';

          const groupHeader = document.createElement('div');
          groupHeader.className = 'group-header';
          groupHeader.innerHTML = `
              <h2>${className}</h2>
              <span>▼</span>
          `;

          const groupContent = document.createElement('div');
          groupContent.className = 'group-content expanded';

          // Environment info
          const environmentInfo = document.createElement('div');
          environmentInfo.className = 'environment-info';
          // Use the first benchmark in the group for environment info
          const sampleBenchmark = groupedData[className][0];
          environmentInfo.innerHTML = `
              <strong>Environment:</strong> ${sampleBenchmark.vmName || 'Unknown VM'} ${sampleBenchmark.vmVersion || ''}
              on ${sampleBenchmark.osName || 'Unknown OS'} ${sampleBenchmark.osVersion || ''}
              ${sampleBenchmark.mode ? `<br><strong>Mode:</strong> ${sampleBenchmark.mode}` : ''}
              ${sampleBenchmark.forks ? `<br><strong>Forks:</strong> ${sampleBenchmark.forks}` : ''}
              ${sampleBenchmark.threads ? `<br><strong>Threads:</strong> ${sampleBenchmark.threads}` : ''}
          `;

          groupContent.appendChild(environmentInfo);

          // Sort button for this group
          const sortBtn = document.createElement('button');
          sortBtn.textContent = 'Sort by Score';
          sortBtn.addEventListener('click', () => {
              sortGroupBenchmarks(className, groupedData[className]);
          });

          // Chart container
          const chartContainer = document.createElement('div');
          chartContainer.className = 'chart-container';
          chartContainer.id = `chart-${className}`;

          // Chart actions
          const chartActions = document.createElement('div');
          chartActions.className = 'chart-actions';

          const copySvgBtn = document.createElement('button');
          copySvgBtn.textContent = 'Copy SVG Code';
          copySvgBtn.addEventListener('click', () => copySvgCode(className));

          chartActions.appendChild(sortBtn);
          chartActions.appendChild(copySvgBtn);
          groupContent.appendChild(chartActions);
          groupContent.appendChild(chartContainer);

          group.appendChild(groupHeader);
          group.appendChild(groupContent);
          resultsContainer.appendChild(group);

          // Toggle group content
          groupHeader.addEventListener('click', () => {
              groupContent.classList.toggle('expanded');
              groupHeader.querySelector('span').textContent =
                  groupContent.classList.contains('expanded') ? '▲' : '▼';

              // Re-render chart when expanded
              if (groupContent.classList.contains('expanded')) {
                  setTimeout(() => {
                      renderChart(className, groupedData[className]);
                  }, 100);
              }
          });

          // Initially render the chart
          setTimeout(() => {
              renderChart(className, groupedData[className]);
          }, 100);
      });
  }

  function renderChart(className, benchmarks) {
      const chartContainer = document.getElementById(`chart-${className}`);
      if (!chartContainer) return;

      // Dispose existing chart
      const existingChart = echarts.getInstanceByDom(chartContainer);
      if (existingChart) {
          existingChart.dispose();
      }

      const chart = echarts.init(chartContainer, null, {
          renderer: rendererSelect.value,
          height: '100%'
      });
      chartInstances.push(chart);

      // Prepare data for chart
      const isHorizontal = chartTypeSelect.value === 'horizontal';

      const benchmarkNames = benchmarks.map(benchmark => {
          const methodName = benchmark.benchmark.split('.').pop();
          const params = benchmark.params && Object.keys(benchmark.params).length > 0 ?
              Object.entries(benchmark.params).map(([key, value]) => `${key}=${value}`).join(', ') : '';
          return params ? `${methodName} (${params})` : methodName;
      });

      const scores = benchmarks.map(benchmark => benchmark.primaryMetric.score);
      const errors = benchmarks.map(benchmark => benchmark.primaryMetric.scoreError || 0);
      const units = benchmarks.map(benchmark => benchmark.primaryMetric.scoreUnit || 'ops/s');

      // Calculate some statistics
      const maxScore = Math.max(...scores);
      const minScore = Math.min(...scores);
      const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;

      const option = {
          title: {
              text: `Benchmark Results - ${className}`,
              left: 'center',
              textStyle: {
                  fontSize: 16
              }
          },
          tooltip: {
              trigger: 'axis',
              axisPointer: {
                  type: 'shadow'
              },
              formatter: function(params) {
                  const dataIndex = params[0].dataIndex;
                  const benchmark = benchmarks[dataIndex];
                  let result = `<b>${params[0].name}</b><br/>`;
                  result += `${params[0].marker} Score: <b>${params[0].value.toFixed(6)}</b><br/>`;
                  result += `Error: ±${errors[dataIndex].toFixed(6)}<br/>`;
                  result += `Units: ${units[dataIndex]}`;

                  // Add params if available
                  if (benchmark.params && Object.keys(benchmark.params).length > 0) {
                      result += `<br/>Params: ${Object.entries(benchmark.params).map(([k, v]) => `${k}=${v}`).join(', ')}`;
                  }

                  return result;
              }
          },
          grid: {
              left: isHorizontal ? '15%' : '3%',
              right: '4%',
              bottom: '10%',
              top: '15%',
              containLabel: true
          },
          xAxis: {
              type: isHorizontal ? 'value' : 'category',
              data: isHorizontal ? null : benchmarkNames,
              name: isHorizontal ? 'Score' : null,
              nameLocation: 'middle',
              nameGap: 30,
              axisLabel: isHorizontal ? null : {
                  interval: 0,
                  rotate: 30,
                  fontSize: 12
              }
          },
          yAxis: {
              type: isHorizontal ? 'category' : 'value',
              data: isHorizontal ? benchmarkNames : null,
              name: isHorizontal ? null : 'Score',
              nameLocation: 'middle',
              nameGap: 40,
              axisLabel: isHorizontal ? {
                  interval: 0,
                  fontSize: 12
              } : null
          },
          series: [
              {
                  name: 'Score',
                  type: 'bar',
                  data: scores.map((score, index) => {
                      return {
                          value: score,
                          itemStyle: {
                              color: getColorForScore(score, minScore, maxScore)
                          }
                      };
                  }),
                  label: {
                      show: true,
                      position: isHorizontal ? 'right' : 'top',
                      formatter: function(params) {
                          return params.value.toFixed(2);
                      },
                      fontSize: 12
                  },
                  markLine: {
                      data: [
                          {
                              type: 'average',
                              name: 'Average',
                              lineStyle: {
                                  color: '#e74c3c',
                                  type: 'dashed'
                              },
                              label: {
                                  formatter: 'Avg: {c}',
                                  position: 'end'
                              }
                          }
                      ],
                      symbol: 'none'
                  }
              },
              {
                  name: 'Error',
                  type: isHorizontal ? 'scatter' : 'line',
                  data: errors,
                  symbolSize: 0,
                  lineStyle: {
                      color: 'red',
                      width: 2
                  },
                  tooltip: {
                      show: false
                  }
              }
          ],
          dataZoom: isHorizontal ? [
              {
                  type: 'slider',
                  yAxisIndex: 0,
                  filterMode: 'filter'
              }
          ] : [
              {
                  type: 'slider',
                  xAxisIndex: 0,
                  filterMode: 'filter'
              }
          ]
      };

      chart.setOption(option);

      // Handle window resize
      window.addEventListener('resize', function() {
          chart.resize();
      });
  }

  function renderAllCharts() {
      if (!benchmarkData) return;

      // Re-process and render all data with new settings
      const groupedData = groupBenchmarksByClass(benchmarkData);

      Object.keys(groupedData).forEach(className => {
          const groupContent = document.querySelector(`#chart-${className}`).closest('.group-content');
          if (groupContent && groupContent.classList.contains('expanded')) {
              renderChart(className, groupedData[className]);
          }
      });
  }

  function sortGroupBenchmarks(className, benchmarks) {
      benchmarks.sort((a, b) => b.primaryMetric.score - a.primaryMetric.score);
      renderChart(className, benchmarks);
  }

  function sortAllBenchmarks() {
      if (!benchmarkData) return;

      const groupedData = groupBenchmarksByClass(benchmarkData);

      Object.keys(groupedData).forEach(className => {
          groupedData[className].sort((a, b) => b.primaryMetric.score - a.primaryMetric.score);
          const groupContent = document.querySelector(`#chart-${className}`).closest('.group-content');
          if (groupContent && groupContent.classList.contains('expanded')) {
              renderChart(className, groupedData[className]);
          }
      });
  }

  function copySvgCode(className) {
      const chartContainer = document.getElementById(`chart-${className}`);
      if (!chartContainer) return;

      const chart = echarts.getInstanceByDom(chartContainer);
      if (!chart) return;

      // Get SVG element
      const svgElement = chartContainer.querySelector('svg');
      if (!svgElement) {
          showError('No SVG element found. Make sure SVG renderer is selected.');
          return;
      }

      // Create a temporary div to get the outerHTML
      const tempDiv = document.createElement('div');
      tempDiv.appendChild(svgElement.cloneNode(true));
      const svgCode = tempDiv.innerHTML;

      // Copy to clipboard
      navigator.clipboard.writeText(svgCode)
          .then(() => {
              copySuccess.style.display = 'block';
              setTimeout(() => {
                  copySuccess.style.display = 'none';
              }, 2000);
          })
          .catch(err => {
              showError('Failed to copy SVG code: ' + err);
          });
  }

  function getColorForScore(score, minScore, maxScore) {
      if (maxScore === minScore) return '#3498db';

      const normalized = (score - minScore) / (maxScore - minScore);

      // Color gradient from blue (low) to green (high)
      const hue = normalized * 120; // 0 (red) to 120 (green) in HSL
      return `hsl(${hue}, 70%, 50%)`;
  }

  function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      hideWarning();
  }

  function showWarning(message) {
      warningMessage.textContent = message;
      warningMessage.style.display = 'block';
  }

  function hideError() {
      errorMessage.style.display = 'none';
  }

  function hideWarning() {
      warningMessage.style.display = 'none';
  }

  // Initialize by trying to load the default file
  window.addEventListener('DOMContentLoaded', () => {
      // Try to load default file, but don't show error if it fails
      loadDefaultFile();
  });
</script>
</body>
</html>