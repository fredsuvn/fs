<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JMH Benchmark Results Visualizer</title>
  <script src="../js/echarts.min.js"></script>
  <style>
    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --danger-color: #e74c3c;
        --dark-color: #2c3e50;
        --light-color: #ecf0f1;
        --border-color: #bdc3c7;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background-color: #f5f7fa;
        color: var(--dark-color);
        line-height: 1.6;
        padding: 20px;
    }

    header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    h1 {
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .controls {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .file-upload {
        margin-bottom: 15px;
    }

    .file-upload-toggle {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin-bottom: 10px;
    }

    .file-upload-toggle h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--dark-color);
    }

    .file-upload-toggle span {
        margin-left: 10px;
        transition: transform 0.3s;
    }

    .file-upload-toggle.collapsed span {
        transform: rotate(-90deg);
    }

    .file-upload-content {
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        max-height: 200px;
    }

    .file-upload-content.collapsed {
        max-height: 0;
    }

    .drop-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 10px;
    }

    .drop-area:hover, .drop-area.highlight {
        border-color: var(--primary-color);
        background-color: rgba(52, 152, 219, 0.05);
    }

    .drop-area p {
        margin: 0;
        color: var(--dark-color);
    }

    .global-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
    }

    button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        font-size: 0.9rem;
    }

    button:hover {
        background-color: #2980b9;
    }

    button.secondary {
        background-color: var(--secondary-color);
    }

    button.secondary:hover {
        background-color: #27ae60;
    }

    button.danger {
        background-color: var(--danger-color);
    }

    button.danger:hover {
        background-color: #c0392b;
    }

    .benchmark-group {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .group-header {
        background-color: var(--dark-color);
        color: white;
        padding: 15px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .group-header h2 {
        margin: 0;
        font-size: 1.2rem;
    }

    .group-content {
        padding: 20px;
    }

    .env-info {
        background-color: var(--light-color);
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }

    .chart-container {
        margin-bottom: 30px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 15px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: bold;
    }

    .chart-controls {
        display: flex;
        gap: 10px;
    }

    .chart {
        width: 100%;
        height: 400px;
        margin-bottom: 10px;
    }

    .error-info {
        background-color: #ffeaa7;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 0.9rem;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .data-table th, .data-table td {
        border: 1px solid var(--border-color);
        padding: 8px 12px;
        text-align: left;
    }

    .data-table th {
        background-color: var(--light-color);
    }

    .data-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    footer {
        text-align: center;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .hidden {
        display: none;
    }

    .sortable {
        cursor: pointer;
    }

    .sortable:hover {
        background-color: rgba(52, 152, 219, 0.1);
    }

    .sort-indicator {
        margin-left: 5px;
        font-size: 0.8rem;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }

    .error-message {
        background-color: #ffeaa7;
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
    }

    .toc {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
    }

    .toc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    .toc-header h2 {
        margin: 0;
        color: var(--primary-color);
    }

    .toc-content {
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        max-height: 500px;
    }

    .toc-content.collapsed {
        max-height: 0;
    }

    .toc-list {
        list-style-type: none;
        padding: 0;
        margin-top: 15px;
    }

    .toc-item {
        margin-bottom: 8px;
    }

    .toc-link {
        color: var(--dark-color);
        text-decoration: none;
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .toc-link:hover {
        background-color: var(--light-color);
        color: var(--primary-color);
    }

    .toc-link::before {
        content: "•";
        margin-right: 10px;
        color: var(--primary-color);
    }

    .sort-btn-asc {
        background-color: #3498db;
    }

    .sort-btn-desc {
        background-color: #e74c3c;
    }

    .sort-btn-original {
        background-color: var(--secondary-color);
    }
  </style>
</head>
<body>
<header>
  <h1>JMH Benchmark Results Visualizer</h1>
  <p>Visualize and analyze your JMH benchmark results</p>
</header>

<div class="controls">
  <div class="file-upload">
    <div class="file-upload-toggle collapsed">
      <h3>File Upload</h3>
      <span>▼</span>
    </div>
    <div class="file-upload-content collapsed">
      <div id="dropArea" class="drop-area">
        <p>Drag & drop your <strong>results.json</strong> file here</p>
        <p>or</p>
        <button id="browseBtn">Browse Files</button>
        <input type="file" id="fileInput" accept=".json" class="hidden">
      </div>
      <p>Default file: <code>results.json</code> in the same directory</p>
    </div>
  </div>

  <div class="global-controls">
    <button id="globalSortBtn" class="secondary">Global Sort by Score</button>
    <button id="toggleAllGroupsBtn">Collapse All Groups</button>
    <button id="globalChartTypeBtn">Switch to Horizontal Bars</button>
    <button id="globalRendererBtn">Switch to Canvas</button>
  </div>
</div>

<div id="tocContainer"></div>
<div id="resultsContainer"></div>

<footer>
  <p>Created by [Your Name]</p>
</footer>

<script>
  // 全局变量
  let benchmarkData = null;
  let globalChartType = 'vertical'; // 'vertical' or 'horizontal'
  let globalRenderer = 'svg'; // 'svg' or 'canvas'
  let globalSortOrder = 'desc'; // 'asc' or 'desc'
  let originalChartData = {}; // 存储每个图表的原始数据

  // DOM元素
  const dropArea = document.getElementById('dropArea');
  const fileInput = document.getElementById('fileInput');
  const browseBtn = document.getElementById('browseBtn');
  const resultsContainer = document.getElementById('resultsContainer');
  const tocContainer = document.getElementById('tocContainer');
  const globalSortBtn = document.getElementById('globalSortBtn');
  const toggleAllGroupsBtn = document.getElementById('toggleAllGroupsBtn');
  const globalChartTypeBtn = document.getElementById('globalChartTypeBtn');
  const globalRendererBtn = document.getElementById('globalRendererBtn');
  const fileUploadToggle = document.querySelector('.file-upload-toggle');
  const fileUploadContent = document.querySelector('.file-upload-content');

  // 事件监听器
  document.addEventListener('DOMContentLoaded', function() {
      // 尝试加载默认的results.json文件
      loadDefaultResults();

      // 设置事件监听器
      setupEventListeners();
  });

  function setupEventListeners() {
      // 文件拖拽事件
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropArea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
          dropArea.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
          dropArea.addEventListener(eventName, unhighlight, false);
      });

      function highlight() {
          dropArea.classList.add('highlight');
      }

      function unhighlight() {
          dropArea.classList.remove('highlight');
      }

      dropArea.addEventListener('drop', handleDrop, false);

      // 文件选择事件
      browseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileSelect);

      // 文件上传区域切换
      fileUploadToggle.addEventListener('click', () => {
          fileUploadToggle.classList.toggle('collapsed');
          fileUploadContent.classList.toggle('collapsed');
      });

      // 全局控制按钮
      globalSortBtn.addEventListener('click', toggleGlobalSort);
      toggleAllGroupsBtn.addEventListener('click', toggleAllGroups);
      globalChartTypeBtn.addEventListener('click', toggleGlobalChartType);
      globalRendererBtn.addEventListener('click', toggleGlobalRenderer);
  }

  function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;

      if (files.length > 0) {
          const file = files[0];
          if (file.type === 'application/json' || file.name.endsWith('.json')) {
              readFile(file);
          } else {
              alert('Please select a JSON file.');
          }
      }
  }

  function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
          readFile(file);
      }
  }

  function readFile(file) {
      const reader = new FileReader();

      reader.onload = function(e) {
          try {
              const data = JSON.parse(e.target.result);
              processBenchmarkData(data);
          } catch (error) {
              alert('Error parsing JSON file: ' + error.message);
          }
      };

      reader.readAsText(file);
  }

  function loadDefaultResults() {
      fetch('results.json')
          .then(response => {
              if (!response.ok) {
                  throw new Error('File not found');
              }
              return response.json();
          })
          .then(data => {
              processBenchmarkData(data);
          })
          .catch(error => {
              console.log('Default results.json not found or error loading: ', error.message);
              // 显示提示信息，而不是错误
              resultsContainer.innerHTML = `
                  <div class="no-data">
                      <h3>No benchmark data loaded</h3>
                      <p>Please drag and drop a results.json file or use the file browser to load your JMH benchmark results.</p>
                  </div>
              `;
          });
  }

  function processBenchmarkData(data) {
      // 验证数据格式
      if (!Array.isArray(data)) {
          showError('Invalid data format: Expected an array of benchmark results');
          return;
      }

      if (data.length === 0) {
          showError('No benchmark results found in the file');
          return;
      }

      // 验证每个benchmark对象
      for (let i = 0; i < data.length; i++) {
          const benchmark = data[i];
          if (!benchmark.benchmark || !benchmark.primaryMetric) {
              showError(`Invalid benchmark data at index ${i}: Missing required fields`);
              return;
          }
      }

      benchmarkData = data;

      // 按benchmark类分组
      const groupedData = groupByBenchmarkClass(data);

      // 渲染结果
      renderResults(groupedData);
  }

  function groupByBenchmarkClass(data) {
      const groups = {};

      data.forEach(benchmark => {
          const className = benchmark.benchmark;
          // 获取简单类名（最后一个.后面的部分）
          const names = className.split('.');
          const simpleClassName = names[names.length - 2];
          // const methodName = names[names.length - 1];

          if (!groups[className]) {
              groups[className] = {
                  benchmarks: [],
                  params: new Set(),
                  primaryMetric: benchmark.primaryMetric,
                  simpleClassName: simpleClassName,
                  // methodName: methodName
              };
          }

          groups[className].benchmarks.push(benchmark);

          // 收集参数信息
          if (benchmark.params) {
              Object.keys(benchmark.params).forEach(param => {
                  groups[className].params.add(param);
              });
          }
      });

      return groups;
  }

  function renderResults(groupedData) {
      resultsContainer.innerHTML = '';
      tocContainer.innerHTML = '';
      originalChartData = {}; // 重置原始数据

      // 如果没有数据，显示提示信息
      if (Object.keys(groupedData).length === 0) {
          resultsContainer.innerHTML = '<p>No benchmark data found.</p>';
          return;
      }

      // 创建目录
      createTableOfContents(groupedData);

      // 创建每个分组
      Object.keys(groupedData).forEach(className => {
          const group = groupedData[className];
          const groupElement = createBenchmarkGroup(className, group);
          resultsContainer.appendChild(groupElement);
      });

      // 初始状态下所有分组展开
      document.querySelectorAll('.group-header').forEach(header => {
          const content = header.nextElementSibling;
          const span = header.querySelector('span');
          content.style.display = 'block';
          span.textContent = '▲';
      });
  }

  function createTableOfContents(groupedData) {
      const tocDiv = document.createElement('div');
      tocDiv.className = 'toc';

      let tocHTML = `
          <div class="toc-header">
              <h2>Table of Contents</h2>
              <span>▼</span>
          </div>
          <div class="toc-content">
              <ul class="toc-list">
      `;

      Object.keys(groupedData).forEach(className => {
          const group = groupedData[className];
          const simpleClassName = group.simpleClassName;
          tocHTML += `
              <li class="toc-item">
                  <a href="#group-${className.replace(/\./g, '-')}" class="toc-link">${simpleClassName}</a>
              </li>
          `;
      });

      tocHTML += '</ul></div>';
      tocDiv.innerHTML = tocHTML;
      tocContainer.appendChild(tocDiv);

      // 添加目录折叠功能
      const tocHeader = tocDiv.querySelector('.toc-header');
      const tocContent = tocDiv.querySelector('.toc-content');

      tocHeader.addEventListener('click', () => {
          tocContent.classList.toggle('collapsed');
          tocHeader.querySelector('span').textContent =
              tocContent.classList.contains('collapsed') ? '►' : '▼';
      });
  }

  function createBenchmarkGroup(className, group) {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'benchmark-group';
      groupDiv.id = `group-${className.replace(/\./g, '-')}`;

      // 组标题 - 使用简单类名
      const headerDiv = document.createElement('div');
      headerDiv.className = 'group-header';
      headerDiv.innerHTML = `
          <h2>${group.simpleClassName}</h2>
          <span>▲</span>
      `;

      // 组内容
      const contentDiv = document.createElement('div');
      contentDiv.className = 'group-content';

      // 环境信息
      if (group.benchmarks.length > 0) {
          const envInfo = group.benchmarks[0];
          const envDiv = createEnvironmentInfo(envInfo);
          contentDiv.appendChild(envDiv);
      }

      // 图表
      const chartDiv = createBenchmarkChart(className, group);
      contentDiv.appendChild(chartDiv);

      // 详细数据表格
      const tableDiv = createDataTable(group);
      contentDiv.appendChild(tableDiv);

      groupDiv.appendChild(headerDiv);
      groupDiv.appendChild(contentDiv);

      // 切换折叠/展开
      headerDiv.addEventListener('click', () => {
          const isExpanded = contentDiv.style.display !== 'none';
          if (isExpanded) {
              contentDiv.style.display = 'none';
              headerDiv.querySelector('span').textContent = '▼';
          } else {
              contentDiv.style.display = 'block';
              headerDiv.querySelector('span').textContent = '▲';
          }
      });

      return groupDiv;
  }

  function createEnvironmentInfo(benchmark) {
      const envDiv = document.createElement('div');
      envDiv.className = 'env-info';

      let envHTML = '<h3>Environment Information</h3>';

      if (benchmark.primaryMetric) {
          envHTML += `<p><strong>Score Unit:</strong> ${benchmark.primaryMetric.scoreUnit}</p>`;
      }

      if (benchmark.mode) {
          envHTML += `<p><strong>Mode:</strong> ${benchmark.mode}</p>`;
      }

      if (benchmark.forks) {
          envHTML += `<p><strong>Forks:</strong> ${benchmark.forks}</p>`;
      }

      if (benchmark.measurementIterations) {
          envHTML += `<p><strong>Measurement Iterations:</strong> ${benchmark.measurementIterations}</p>`;
      }

      if (benchmark.warmupIterations) {
          envHTML += `<p><strong>Warmup Iterations:</strong> ${benchmark.warmupIterations}</p>`;
      }

      if (benchmark.threads) {
          envHTML += `<p><strong>Threads:</strong> ${benchmark.threads}</p>`;
      }

      envDiv.innerHTML = envHTML;
      return envDiv;
  }

  function createBenchmarkChart(className, group) {
      const chartContainer = document.createElement('div');
      chartContainer.className = 'chart-container';
      chartContainer.id = `chart-container-${className.replace(/\./g, '-')}`;

      // 图表标题和控制 - 使用简单类名
      const chartHeader = document.createElement('div');
      chartHeader.className = 'chart-header';

      const chartTitle = document.createElement('div');
      chartTitle.className = 'chart-title';
      chartTitle.textContent = `${group.simpleClassName} - Performance Results`;

      const chartControls = document.createElement('div');
      chartControls.className = 'chart-controls';

      const sortBtn = document.createElement('button');
      sortBtn.className = 'secondary sort-btn-original';
      sortBtn.textContent = 'Sort: Original';
      sortBtn.setAttribute('data-sort-state', 'original');
      sortBtn.addEventListener('click', () => toggleChartSort(chartContainer, group, sortBtn));

      const chartTypeBtn = document.createElement('button');
      chartTypeBtn.textContent = globalChartType === 'vertical' ? 'Horizontal Bars' : 'Vertical Bars';
      chartTypeBtn.addEventListener('click', () => toggleChartType(chartContainer, group, chartTypeBtn));

      const rendererBtn = document.createElement('button');
      rendererBtn.textContent = globalRenderer === 'svg' ? 'Use Canvas' : 'Use SVG';
      rendererBtn.addEventListener('click', () => toggleRenderer(chartContainer, group, rendererBtn));

      const copySvgBtn = document.createElement('button');
      copySvgBtn.className = 'secondary';
      copySvgBtn.textContent = 'Copy SVG';
      copySvgBtn.addEventListener('click', () => copySvgCode(chartContainer));

      chartControls.appendChild(sortBtn);
      chartControls.appendChild(chartTypeBtn);
      chartControls.appendChild(rendererBtn);
      chartControls.appendChild(copySvgBtn);

      chartHeader.appendChild(chartTitle);
      chartHeader.appendChild(chartControls);

      // 图表容器
      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart';
      chartDiv.id = `chart-${className.replace(/\./g, '-')}`;

      chartContainer.appendChild(chartHeader);
      chartContainer.appendChild(chartDiv);

      // 初始化图表
      renderChart(chartDiv, group, globalChartType, globalRenderer);

      // 保存原始数据
      saveOriginalChartData(chartContainer, group);

      return chartContainer;
  }

  function saveOriginalChartData(chartContainer, group) {
      const chartId = chartContainer.id;

      // 准备原始数据
      originalChartData[chartId] = {
          xAxisData: [],
          seriesData: [],
          errorData: []
      };

      group.benchmarks.forEach(benchmark => {
          // 生成标签：方法名 + 参数
          let label = benchmark.benchmark.split('.').pop(); // 方法名
          if (benchmark.params) {
              const paramValues = Object.values(benchmark.params).join(', ');
              label += ` (${paramValues})`;
          }
          originalChartData[chartId].xAxisData.push(label);

          // 分数和误差
          const score = benchmark.primaryMetric.score;
          originalChartData[chartId].seriesData.push(score);

          // 修复：安全处理scoreError
          let error = 0;
          if (benchmark.primaryMetric.scoreError && typeof benchmark.primaryMetric.scoreError === 'number') {
              error = benchmark.primaryMetric.scoreError;
          }
          originalChartData[chartId].errorData.push(error);
      });
  }

  function toggleChartSort(chartContainer, group, sortBtn) {
      const chartDiv = chartContainer.querySelector('.chart');
      const currentChart = chartDiv.chartInstance;
      const currentState = sortBtn.getAttribute('data-sort-state');
      const chartId = chartContainer.id;

      // 获取原始数据
      const originalData = originalChartData[chartId];
      if (!originalData) return;

      // 获取当前选项
      const option = currentChart.getOption();
      const isHorizontal = option.xAxis[0].type === 'value'; // 判断是否为水平条形图

      // 根据当前状态决定下一个状态
      let newState, sortedXAxisData, sortedYAxisData, sortedSeriesData;

      if (currentState === 'original') {
          // 切换到升序
          newState = 'asc';
          sortBtn.textContent = 'Sort: Ascending';
          sortBtn.className = 'secondary sort-btn-asc';

          // 创建索引数组并按分数升序排序
          const indices = Array.from({length: originalData.seriesData.length}, (_, i) => i);
          indices.sort((a, b) => originalData.seriesData[a] - originalData.seriesData[b]);

          // 重新排序数据
          sortedXAxisData = indices.map(i => originalData.xAxisData[i]);
          sortedSeriesData = indices.map(i => originalData.seriesData[i]);
      } else if (currentState === 'asc') {
          // 切换到降序
          newState = 'desc';
          sortBtn.textContent = 'Sort: Descending';
          sortBtn.className = 'secondary sort-btn-desc';

          // 创建索引数组并按分数降序排序
          const indices = Array.from({length: originalData.seriesData.length}, (_, i) => i);
          indices.sort((a, b) => originalData.seriesData[b] - originalData.seriesData[a]);

          // 重新排序数据
          sortedXAxisData = indices.map(i => originalData.xAxisData[i]);
          sortedSeriesData = indices.map(i => originalData.seriesData[i]);
      } else {
          // 切换到原顺序
          newState = 'original';
          sortBtn.textContent = 'Sort: Original';
          sortBtn.className = 'secondary sort-btn-original';

          // 使用原始数据
          sortedXAxisData = [...originalData.xAxisData];
          sortedSeriesData = [...originalData.seriesData];
      }

      // 更新排序状态
      sortBtn.setAttribute('data-sort-state', newState);

      // 更新图表
      if (isHorizontal) {
          // 水平条形图：更新y轴数据
          option.yAxis[0].data = sortedXAxisData;
          option.series[0].data = sortedSeriesData;

          // 更新误差线数据（如果有）
          if (option.series.length > 1) {
              const errorSeries = option.series[1];
              if (errorSeries.markLine && errorSeries.markLine.data) {
                  const sortedErrorData = indices.map(i => {
                      const originalIndex = indices.indexOf(i);
                      return errorSeries.markLine.data[originalIndex];
                  });
                  errorSeries.markLine.data = sortedErrorData;
              }
          }
      } else {
          // 垂直条形图：更新x轴数据
          option.xAxis[0].data = sortedXAxisData;
          option.series[0].data = sortedSeriesData;

          // 更新误差线数据（如果有）
          if (option.series.length > 1) {
              const errorSeries = option.series[1];
              if (errorSeries.markLine && errorSeries.markLine.data) {
                  const sortedErrorData = indices.map(i => {
                      const originalIndex = indices.indexOf(i);
                      return errorSeries.markLine.data[originalIndex];
                  });
                  errorSeries.markLine.data = sortedErrorData;
              }
          }
      }

      currentChart.setOption(option);
  }

  function renderChart(chartDiv, group, chartType, renderer) {
      // 准备数据
      const benchmarks = group.benchmarks;
      const xAxisData = [];
      const seriesData = [];
      const errorData = [];

      benchmarks.forEach(benchmark => {
          // 生成标签：方法名 + 参数
          let label = benchmark.benchmark.split('.').pop(); // 方法名
          if (benchmark.params) {
              const paramValues = Object.values(benchmark.params).join(', ');
              label += ` (${paramValues})`;
          }
          xAxisData.push(label);

          // 分数和误差
          const score = benchmark.primaryMetric.score;
          seriesData.push(score);

          // 修复：安全处理scoreError
          let error = 0;
          if (benchmark.primaryMetric.scoreError && typeof benchmark.primaryMetric.scoreError === 'number') {
              error = benchmark.primaryMetric.scoreError;
          }
          errorData.push(error);
      });

      // 配置项
      const option = {
          tooltip: {
              trigger: 'axis',
              axisPointer: {
                  type: 'shadow'
              },
              formatter: function(params) {
                  const dataIndex = params[0].dataIndex;
                  const benchmark = benchmarks[dataIndex];
                  let tooltip = `<strong>${params[0].name}</strong><br/>`;
                  tooltip += `Score: ${params[0].value} ${benchmark.primaryMetric.scoreUnit}<br/>`;

                  if (errorData[dataIndex] && errorData[dataIndex] > 0) {
                      tooltip += `Error: ±${errorData[dataIndex]} ${benchmark.primaryMetric.scoreUnit}<br/>`;
                  }

                  if (benchmark.params) {
                      Object.keys(benchmark.params).forEach(param => {
                          tooltip += `${param}: ${benchmark.params[param]}<br/>`;
                      });
                  }

                  return tooltip;
              }
          },
          xAxis: {
              type: chartType === 'vertical' ? 'category' : 'value',
              data: chartType === 'vertical' ? xAxisData : null,
              axisLabel: {
                  interval: 0,
                  rotate: 30
              }
          },
          yAxis: {
              type: chartType === 'vertical' ? 'value' : 'category',
              data: chartType === 'vertical' ? null : xAxisData
          },
          series: [
              {
                  name: 'Score',
                  type: 'bar',
                  data: seriesData,
                  itemStyle: {
                      color: '#3498db'
                  },
                  label: {
                      show: true,
                      position: chartType === 'vertical' ? 'top' : 'right',
                      formatter: function(params) {
                          // 格式化数字显示
                          return formatNumber(params.value);
                      }
                  },
                  markLine: {
                      data: [
                          { type: 'average', name: 'Average' }
                      ]
                  }
              }
          ]
      };

      // 只有在有误差数据时才添加误差线
      if (errorData.some(error => error > 0)) {
          option.series.push({
              name: 'Error',
              type: chartType === 'vertical' ? 'scatter' : 'scatter',
              data: errorData.map((error, index) => {
                  return chartType === 'vertical' ?
                      [index, seriesData[index] + error] :
                      [seriesData[index] + error, index];
              }),
              symbolSize: 0,
              itemStyle: {
                  color: 'transparent'
              },
              tooltip: {
                  show: false
              },
              markLine: {
                  symbol: 'none',
                  lineStyle: {
                      type: 'solid',
                      color: '#e74c3c'
                  },
                  data: errorData.map((error, index) => {
                      if (error > 0) {
                          return chartType === 'vertical' ?
                              [
                                  { coord: [index, seriesData[index] - error] },
                                  { coord: [index, seriesData[index] + error] }
                              ] :
                              [
                                  { coord: [seriesData[index] - error, index] },
                                  { coord: [seriesData[index] + error, index] }
                              ];
                      }
                      return null;
                  }).filter(item => item !== null)
              }
          });
      }

      // 修复：初始化图表时不设置宽度和高度，让ECharts自动使用容器尺寸
      const chart = echarts.init(chartDiv, null, {
          renderer: renderer
      });

      chart.setOption(option);

      // 修复：立即调整图表大小以确保正确显示
      setTimeout(() => {
          chart.resize();
      }, 0);

      // 响应窗口大小变化
      window.addEventListener('resize', function() {
          chart.resize();
      });

      // 存储图表实例以便后续操作
      chartDiv.chartInstance = chart;
  }

  function createDataTable(group) {
      const tableContainer = document.createElement('div');

      const table = document.createElement('table');
      table.className = 'data-table';

      // 表头
      const thead = document.createElement('thead');
      let headerHTML = '<tr>';
      headerHTML += '<th class="sortable" data-sort="method">Method <span class="sort-indicator">▼</span></th>';

      // 参数列
      if (group.params.size > 0) {
          Array.from(group.params).forEach(param => {
              headerHTML += `<th>${param}</th>`;
          });
      }

      headerHTML += '<th class="sortable" data-sort="score">Score <span class="sort-indicator">▼</span></th>';
      headerHTML += '<th>Error</th>';
      headerHTML += '<th>Unit</th>';
      headerHTML += '</tr>';
      thead.innerHTML = headerHTML;

      // 表体
      const tbody = document.createElement('tbody');
      group.benchmarks.forEach(benchmark => {
          let rowHTML = '<tr>';

          // 方法名
          const methodName = benchmark.benchmark.split('.').pop();
          rowHTML += `<td>${methodName}</td>`;

          // 参数
          if (group.params.size > 0) {
              Array.from(group.params).forEach(param => {
                  const paramValue = benchmark.params && benchmark.params[param] ?
                      benchmark.params[param] : '-';
                  rowHTML += `<td>${paramValue}</td>`;
              });
          }

          // 分数和误差
          const score = formatNumber(benchmark.primaryMetric.score);

          // 修复：安全处理scoreError
          let error = '-';
          if (benchmark.primaryMetric.scoreError && typeof benchmark.primaryMetric.scoreError === 'number') {
              error = formatNumber(benchmark.primaryMetric.scoreError);
          }

          const unit = benchmark.primaryMetric.scoreUnit;

          rowHTML += `<td>${score}</td>`;
          rowHTML += `<td>${error}</td>`;
          rowHTML += `<td>${unit}</td>`;
          rowHTML += '</tr>';

          tbody.innerHTML += rowHTML;
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      tableContainer.appendChild(table);

      // 添加排序功能
      const sortableHeaders = table.querySelectorAll('th.sortable');
      sortableHeaders.forEach(header => {
          header.addEventListener('click', function() {
              const sortBy = this.getAttribute('data-sort');
              sortTable(table, sortBy);
          });
      });

      return tableContainer;
  }

  function sortTable(table, sortBy) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const header = table.querySelector(`th[data-sort="${sortBy}"]`);
      const currentOrder = header.getAttribute('data-order') || 'desc';
      const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';

      // 更新排序指示器
      table.querySelectorAll('.sort-indicator').forEach(indicator => {
          indicator.textContent = '';
      });
      header.querySelector('.sort-indicator').textContent = newOrder === 'desc' ? '▼' : '▲';

      // 更新所有表头的排序状态
      table.querySelectorAll('th.sortable').forEach(th => {
          th.removeAttribute('data-order');
      });
      header.setAttribute('data-order', newOrder);

      // 排序行
      rows.sort((a, b) => {
          let aValue, bValue;

          if (sortBy === 'method') {
              aValue = a.cells[0].textContent;
              bValue = b.cells[0].textContent;
          } else if (sortBy === 'score') {
              // 找到分数列（考虑参数列的数量）
              const paramCount = table.querySelector('thead tr').childElementCount - 4; // 方法、分数、误差、单位
              const scoreIndex = 1 + paramCount; // 方法列 + 参数列数
              aValue = parseFloat(a.cells[scoreIndex].textContent);
              bValue = parseFloat(b.cells[scoreIndex].textContent);
          }

          if (newOrder === 'asc') {
              return aValue > bValue ? 1 : -1;
          } else {
              return aValue < bValue ? 1 : -1;
          }
      });

      // 重新添加行
      rows.forEach(row => tbody.appendChild(row));
  }

  function toggleGlobalSort() {
      globalSortOrder = globalSortOrder === 'desc' ? 'asc' : 'desc';
      globalSortBtn.textContent = `Global Sort by Score (${globalSortOrder.toUpperCase()})`;

      // 实现全局排序功能
      if (benchmarkData) {
          // 对每个分组中的benchmarks进行排序
          const groupedData = groupByBenchmarkClass(benchmarkData);

          Object.keys(groupedData).forEach(className => {
              const group = groupedData[className];
              group.benchmarks.sort((a, b) => {
                  if (globalSortOrder === 'asc') {
                      return a.primaryMetric.score - b.primaryMetric.score;
                  } else {
                      return b.primaryMetric.score - a.primaryMetric.score;
                  }
              });
          });

          // 重新渲染结果
          renderResults(groupedData);
      }
  }

  function toggleAllGroups() {
      const groupContents = document.querySelectorAll('.group-content');
      const allExpanded = Array.from(groupContents).every(content =>
          content.style.display !== 'none');

      groupContents.forEach(content => {
          const header = content.previousElementSibling;

          if (allExpanded) {
              content.style.display = 'none';
              header.querySelector('span').textContent = '▼';
          } else {
              content.style.display = 'block';
              header.querySelector('span').textContent = '▲';
          }
      });

      toggleAllGroupsBtn.textContent = allExpanded ? 'Expand All Groups' : 'Collapse All Groups';
  }

  function toggleGlobalChartType() {
      globalChartType = globalChartType === 'vertical' ? 'horizontal' : 'vertical';
      globalChartTypeBtn.textContent = globalChartType === 'vertical' ?
          'Switch to Horizontal Bars' : 'Switch to Vertical Bars';

      // 重新渲染所有图表，但不重新渲染整个分组
      if (benchmarkData) {
          const groupedData = groupByBenchmarkClass(benchmarkData);

          // 只重新渲染图表，保持分组状态
          document.querySelectorAll('.chart-container').forEach((container, index) => {
              const chartDiv = container.querySelector('.chart');
              const className = Object.keys(groupedData)[index];
              const group = groupedData[className];

              // 重新渲染图表
              renderChart(chartDiv, group, globalChartType, globalRenderer);

              // 重新保存原始数据
              saveOriginalChartData(container, group);

              // 重置排序按钮状态
              const sortBtn = container.querySelector('.chart-controls button.secondary');
              if (sortBtn) {
                  sortBtn.textContent = 'Sort: Original';
                  sortBtn.className = 'secondary sort-btn-original';
                  sortBtn.setAttribute('data-sort-state', 'original');
              }
          });
      }
  }

  function toggleGlobalRenderer() {
      globalRenderer = globalRenderer === 'svg' ? 'canvas' : 'svg';
      globalRendererBtn.textContent = globalRenderer === 'svg' ?
          'Switch to Canvas' : 'Switch to SVG';

      // 重新渲染所有图表，但不重新渲染整个分组
      if (benchmarkData) {
          const groupedData = groupByBenchmarkClass(benchmarkData);

          // 只重新渲染图表，保持分组状态
          document.querySelectorAll('.chart-container').forEach((container, index) => {
              const chartDiv = container.querySelector('.chart');
              const className = Object.keys(groupedData)[index];
              const group = groupedData[className];

              // 重新渲染图表
              renderChart(chartDiv, group, globalChartType, globalRenderer);

              // 重新保存原始数据
              saveOriginalChartData(container, group);

              // 重置排序按钮状态
              const sortBtn = container.querySelector('.chart-controls button.secondary');
              if (sortBtn) {
                  sortBtn.textContent = 'Sort: Original';
                  sortBtn.className = 'secondary sort-btn-original';
                  sortBtn.setAttribute('data-sort-state', 'original');
              }
          });
      }
  }

  function toggleChartType(chartContainer, group, button) {
      const chartDiv = chartContainer.querySelector('.chart');
      const currentType = button.textContent.includes('Horizontal') ? 'vertical' : 'horizontal';
      const newType = currentType === 'vertical' ? 'horizontal' : 'vertical';

      button.textContent = newType === 'vertical' ? 'Horizontal Bars' : 'Vertical Bars';

      // 重新渲染图表
      renderChart(chartDiv, group, newType, globalRenderer);

      // 重新保存原始数据
      saveOriginalChartData(chartContainer, group);

      // 重置排序按钮状态
      const sortBtn = chartContainer.querySelector('.chart-controls button.secondary');
      if (sortBtn) {
          sortBtn.textContent = 'Sort: Original';
          sortBtn.className = 'secondary sort-btn-original';
          sortBtn.setAttribute('data-sort-state', 'original');
      }
  }

  function toggleRenderer(chartContainer, group, button) {
      const chartDiv = chartContainer.querySelector('.chart');
      const currentRenderer = button.textContent.includes('Canvas') ? 'svg' : 'canvas';
      const newRenderer = currentRenderer === 'svg' ? 'canvas' : 'svg';

      button.textContent = newRenderer === 'svg' ? 'Use Canvas' : 'Use SVG';

      // 重新渲染图表
      renderChart(chartDiv, group, globalChartType, newRenderer);

      // 重新保存原始数据
      saveOriginalChartData(chartContainer, group);

      // 重置排序按钮状态
      const sortBtn = chartContainer.querySelector('.chart-controls button.secondary');
      if (sortBtn) {
          sortBtn.textContent = 'Sort: Original';
          sortBtn.className = 'secondary sort-btn-original';
          sortBtn.setAttribute('data-sort-state', 'original');
      }
  }

  function copySvgCode(chartContainer) {
      const chartDiv = chartContainer.querySelector('.chart');
      const chart = chartDiv.chartInstance;

      if (globalRenderer !== 'svg') {
          alert('SVG code can only be copied when using SVG renderer.');
          return;
      }

      // 获取SVG元素
      const svgElement = chart.getDom().querySelector('svg');
      if (!svgElement) {
          alert('No SVG element found. Please ensure you are using SVG renderer.');
          return;
      }

      // 序列化SVG
      const serializer = new XMLSerializer();
      const svgCode = serializer.serializeToString(svgElement);

      // 复制到剪贴板
      navigator.clipboard.writeText(svgCode)
          .then(() => {
              alert('SVG code copied to clipboard!');
          })
          .catch(err => {
              console.error('Failed to copy SVG code: ', err);
              alert('Failed to copy SVG code. See console for details.');
          });
  }

  // 辅助函数：格式化数字显示
  function formatNumber(num) {
      if (typeof num !== 'number') return num;

      if (num === 0) return '0';
      if (Math.abs(num) < 0.001) return num.toExponential(4);
      if (Math.abs(num) < 1) return num.toFixed(6);
      if (Math.abs(num) < 10) return num.toFixed(4);
      if (Math.abs(num) < 100) return num.toFixed(3);
      if (Math.abs(num) < 1000) return num.toFixed(2);
      if (Math.abs(num) < 10000) return num.toFixed(1);
      return num.toFixed(0);
  }

  // 辅助函数：显示错误信息
  function showError(message) {
      resultsContainer.innerHTML = `
          <div class="error-message">
              <h3>Error Loading Data</h3>
              <p>${message}</p>
              <p>Please check your JSON file format and try again.</p>
          </div>
      `;
  }
</script>
</body>
</html>